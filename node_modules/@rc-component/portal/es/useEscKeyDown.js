import { useEffect, useMemo } from 'react';
import useId from "@rc-component/util/es/hooks/useId";
import { useEvent } from '@rc-component/util';
export let stack = []; // export for testing

export default function useEscKeyDown(open, onEsc) {
  const id = useId();
  const handleEscKeyDown = useEvent(event => {
    if (event.key === 'Escape' && !event.isComposing) {
      const top = stack[stack.length - 1] === id;
      onEsc?.({
        top,
        event
      });
    }
  });
  useMemo(() => {
    if (open && !stack.includes(id)) {
      stack.push(id);
    } else if (!open) {
      stack = stack.filter(item => item !== id);
    }
  }, [open, id]);
  useEffect(() => {
    if (open && !stack.includes(id)) {
      stack.push(id);
    }
    if (!open) {
      return;
    }
    window.addEventListener('keydown', handleEscKeyDown);
    return () => {
      stack = stack.filter(item => item !== id);
      window.removeEventListener('keydown', handleEscKeyDown);
    };
  }, [open, id]);
}